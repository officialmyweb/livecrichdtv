<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JWPlayer Token Handler</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body {
      margin: 0;
      background: #000;
    }
    #player {
      width: 100%;
      height: 100vh;
    }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = "XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo";

    // --- Get ?id= from URL ---
    function getChannelId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get("id");
    }

    // --- Extract token from mpd_url ---
    function extractTokenFromLink(link) {
      const tokenMatch = link.match(/__hdnea__=([^&]+)/);
      return tokenMatch ? tokenMatch[1] : "";
    }

    // --- Inject token into requests ---
    function interceptNetworkRequests(token) {
      const originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {
        if (url.startsWith("https://tv.media.jio.com/")) {
          url = url.replace(
            "tv.media.jio.com",
            "your.proxy.if.want.to.play.worldwide.otherwise.remains.same"
          );
        }

        if (
          (url.includes(".mpd") || url.includes(".m3u8") || url.includes(".ts")) &&
          token &&
          !url.includes("__hdnea__=")
        ) {
          url += (url.includes("?") ? "&" : "?") + "__hdnea__=" + token;
        }

        originalOpen.apply(this, [method, url]);
      };
    }

    // --- Main player loader ---
    async function playChannel() {
      try {
        const response = await fetch("https://ipl.hypetg.fun/jtv.php");
        const channels = await response.json();
        const id = getChannelId();

        const channel = channels.find(
          (c) => c.name.toLowerCase() === id.toLowerCase()
        );

        if (!channel) {
          alert("Channel not found!");
          return;
        }

        const link = channel.mpd_url;
        const token = extractTokenFromLink(link);
        interceptNetworkRequests(token);

        const [keyId, key] = channel.license_key.split(":");

        const playerInstance = jwplayer("player");
        playerInstance.setup({
          playlist: [
            {
              file: link,
              type: "dash",
            },
          ],
          drm: {
            clearkey: {
              keyId: keyId,
              key: key,
            },
          },
          width: "100%",
          aspectratio: "16:9",
          autostart: true,
          cast: {
            appid: "CC1AD845",
          },
        });

        playerInstance.on("beforePlay", function () {
          interceptNetworkRequests(token);
        });
      } catch (e) {
        console.error("Error loading channel:", e);
      }
    }

    window.onload = playChannel;
  </script>
</body>
</html>
