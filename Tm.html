<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JW JSON Player</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin:0; background:#000; }
    #player { width:100%; height:100vh; }
    .error-message {
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      color:#fff; font-size:1.5rem; text-align:center;
      padding:20px; background:rgba(0,0,0,0.8);
      z-index:1000; display:none;
    }
  </style>
</head>
<body>
  <div id="player"></div>
  <div class="error-message" id="errorMessage"></div>

<script>
jwplayer.key = "XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo";

// ---- Utility ----
function getChannelId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

function extractTokenFromLink(link) {
  const tokenMatch = link.match(/__hdnea__=([^&]+)/);
  return tokenMatch ? tokenMatch[1] : "";
}

function interceptNetworkRequests(token) {
  const originalOpen = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url) {
    if ((url.includes(".mpd") || url.includes(".m3u8") || url.includes(".ts"))) {
      if (token && !url.includes("__hdnea__=")) {
        url += (url.includes("?") ? "&" : "?") + "__hdnea__=" + token;
      }
    }
    originalOpen.apply(this, [method, url]);
  };

  const originalSend = XMLHttpRequest.prototype.send;
  XMLHttpRequest.prototype.send = function(body) {
    this.setRequestHeader("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64)");
    this.setRequestHeader("Origin", "https://jiotv.com");
    this.setRequestHeader("Referer", "https://jiotv.com/");
    originalSend.call(this, body);
  };
}

function showError(msg) {
  const d = document.getElementById("errorMessage");
  d.textContent = msg;
  d.style.display = "flex";
}

// ---- Main Loader ----
async function playChannel() {
  try {
    const resp = await fetch("https://ipl.hypetg.fun/jtv.php");
    const channels = await resp.json();
    const id = getChannelId();
    if (!id) { showError("Use ?id=CHANNEL_NAME in URL"); return; }

    const channel = channels.find(c => c.name.toLowerCase() === id.toLowerCase());
    if (!channel) { showError("Channel not found: " + id); return; }

    const mpdUrl = channel.mpd_url;
    const [keyId, key] = channel.license_key.split(":");

    if (!mpdUrl || !keyId || !key) {
      showError("Missing mpd_url or license_key for channel: " + id);
      return;
    }

    // Token & headers
    const token = extractTokenFromLink(mpdUrl);
    interceptNetworkRequests(token);

    // Setup JWPlayer
    const playerInstance = jwplayer("player");
    playerInstance.setup({
      playlist: [{
        file: mpdUrl,
        image: channel.logo || "",
        type: "dash"
      }],
      drm: {
        clearkey: {
          keyId: keyId,
          key: key
        }
      },
      width: "100%",
      aspectratio: "16:9",
      autostart: true
    });

    playerInstance.on("beforePlay", function() {
      interceptNetworkRequests(token);
    });

  } catch (err) {
    console.error("Error loading channel:", err);
    showError("Failed: " + err.message);
  }
}

window.onload = playChannel;
</script>
</body>
</html>
