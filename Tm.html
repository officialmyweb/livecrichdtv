<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shaka JSON Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.2/shaka-player.ui.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.9.2/controls.min.css">
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    #video { width:100%; height:100%; }
    .error-message {
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      color:#fff; font-size:1.5rem; text-align:center;
      padding:20px; background:rgba(0,0,0,0.8);
      z-index:1000; display:none;
    }
  </style>
</head>
<body>
  <video id="video" autoplay controls></video>
  <div class="error-message" id="errorMessage"></div>

<script>
async function initApp() {
  // Install polyfills
  shaka.polyfill.installAll();
  if (!shaka.Player.isBrowserSupported()) {
    showError("Browser not supported by Shaka Player");
    return;
  }

  const video = document.getElementById('video');
  const player = new shaka.Player(video);

  // UI wrapper
  const ui = new shaka.ui.Overlay(player, video.parentElement, video);

  player.addEventListener('error', e => {
    console.error('Shaka error', e);
    showError("Playback error: " + e.detail);
  });

  const id = getChannelId();
  if (!id) { showError("Use ?id=CHANNEL_NAME in URL"); return; }

  try {
    // Fetch JSON channel list
    const resp = await fetch("https://ipl.hypetg.fun/jtv.php");
    const channels = await resp.json();

    // Match by ?id=
    const channel = channels.find(c => c.name.toLowerCase() === id.toLowerCase());
    if (!channel) { showError("Channel not found: " + id); return; }

    const mpdUrl = channel.mpd_url;
    const [keyId, key] = channel.license_key.split(":");
    if (!mpdUrl || !keyId || !key) {
      showError("Invalid channel data");
      return;
    }

    const token = extractTokenFromLink(mpdUrl);

    // Request filters for headers and token injection
    player.getNetworkingEngine().registerRequestFilter((type, request) => {
      if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT ||
          type === shaka.net.NetworkingEngine.RequestType.MANIFEST) {

        // Inject headers
        request.headers['User-Agent'] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64)";
        request.headers['Origin'] = "https://jiotv.com";
        request.headers['Referer'] = "https://jiotv.com/";

        // Append token if not present
        if (token && !request.uris[0].includes("__hdnea__=")) {
          request.uris[0] += (request.uris[0].includes("?") ? "&" : "?") + "__hdnea__=" + token;
        }
      }
    });

    // Configure ClearKey DRM
    player.configure({
      drm: {
        clearKeys: {
          [keyId]: key
        }
      }
    });

    // Load the MPD
    await player.load(mpdUrl);
    console.log("Playing:", channel.name);

  } catch (err) {
    console.error("Load error", err);
    showError("Failed: " + err.message);
  }
}

function getChannelId() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id");
}

function extractTokenFromLink(link) {
  const tokenMatch = link.match(/__hdnea__=([^&]+)/);
  return tokenMatch ? tokenMatch[1] : "";
}

function showError(msg) {
  const d = document.getElementById("errorMessage");
  d.textContent = msg;
  d.style.display = "flex";
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
