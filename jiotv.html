<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JWPlayer M3U Handler</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script> <!-- JWPlayer core -->
  <style>
    body {
      margin: 0;
      background: #000;
    }
    #player {
      width: 100%;
      height: 100vh;
    }
    .error-message {
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      color:#fff; font-size:1.5rem; text-align:center;
      padding:20px; background:rgba(0,0,0,0.7);
      display:none; z-index:1000;
    }
  </style>
</head>
<body>
  <div id="player"></div>
  <div class="error-message" id="errorMessage"></div>

  <script>
  jwplayer.key = "XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo"; // your JW key

  document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const channelId = urlParams.get("id");
    if (!channelId) { showError("Provide ?id=CHANNEL_ID"); return; }

    let mpdUrl="", keyId="", key="", cookieHeader="";

    try {
      const m3uUrl = "https://raw.githubusercontent.com/alex4528/m3u/main/jstar.m3u";
      const resp = await fetch(m3uUrl);
      const text = await resp.text();
      const lines = text.split("\n");

      for (let i=0;i<lines.length;i++) {
        if (lines[i].includes(`tvg-id="${channelId}"`)) {
          for (let j=i+1;j<lines.length;j++) {
            if (lines[j].startsWith("#EXTINF")) break;
            if (lines[j].includes("license_key=")) {
              const match = lines[j].match(/license_key=([^:]+):([a-f0-9]+)/i);
              if (match) { keyId=match[1]; key=match[2]; }
            }
            if (lines[j].startsWith("#EXTHTTP:")) {
              const cookieMatch = lines[j].match(/"cookie":"([^"]+)"/);
              if (cookieMatch) cookieHeader=cookieMatch[1];
            }
            if (lines[j].startsWith("http")) {
              mpdUrl = lines[j].split("&xxx")[0];
            }
          }
          break;
        }
      }
      if (!mpdUrl || !keyId || !key) {
        showError("Channel or key parsing failed"); 
        return;
      }
    } catch(err) {
      showError("Failed to fetch M3U: "+err.message);
      return;
    }

    // JWPlayer DRM config (ClearKey)
    const drmConfig = {
      clearkey: { 
        keyId: keyId, 
        key: key 
      }
    };

    // Setup JWPlayer
    jwplayer("player").setup({
      file: mpdUrl,
      type: "dash",
      drm: drmConfig,
      width: "100%",
      height: "100%",
      autostart: true
    });

    // Inject headers for manifest/segment requests
    jwplayer("player").on("beforePlay", function() {
      jwplayer("player").setConfig({
        ajax: {
          headers: {
            "Referer": "https://www.jiotv.com/",
            "User-Agent": "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6",
            "Cookie": cookieHeader
          }
        }
      });
    });

  });

  function showError(msg){
    const d=document.getElementById("errorMessage");
    d.textContent=msg; d.style.display="flex";
  }
  </script>
</body>
</html>
