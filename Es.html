<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U â†’ JWPlayer (Dynamic JSON Parser)</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin: 0; background: #000; }
    #player { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    function setCookie(name, value) {
      document.cookie = name + "=" + value + "; path=/";
    }

    async function loadAndPlay() {
      const urlParams = new URLSearchParams(window.location.search);
      const channelId = urlParams.get("id");
      if (!channelId) {
        alert("No channel id provided (?id=1373)");
        return;
      }

      const jsonUrl = "https://pkl.xojiv79335.workers.dev/";
      const response = await fetch(jsonUrl);
      const channels = await response.json();

      // find the channel by id
      const channel = channels.find(c => c.channel_id === channelId);
      if (!channel) {
        alert("Channel not found in JSON.");
        return;
      }

      // set cookie if exists
      if (channel.cookie) {
        const cookieParts = channel.cookie.split("=");
        if (cookieParts.length >= 2) {
          setCookie(cookieParts[0], cookieParts.slice(1).join("="));
        }
      }

      jwplayer("player").setup({
        playlist: [{
          file: channel.channel_url,
          type: "dash",
          drm: {
            clearkey: {
              [channel.keyId]: channel.key
            }
          },
          image: channel.channel_logo,
          title: channel.channel_name
        }],
        width: "100%",
        aspectratio: "16:9",
        autostart: true
      });
    }

    window.onload = loadAndPlay;
  </script>
</body>
</html>
