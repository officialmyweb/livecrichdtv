<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U â†’ JWPlayer (Multi-ID)</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin: 0; background: #000; }
    #player { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = "XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo";

    const m3uUrl = "https://raw.githubusercontent.com/alex4528/m3u/main/jstar.m3u";

    // Get ?id= param from URL
    function getIdParam() {
      const urlParams = new URLSearchParams(window.location.search);
      return parseInt(urlParams.get("id") || "1", 10);
    }

    async function fetchM3U() {
      const response = await fetch(m3uUrl);
      const m3uText = await response.text();
      return parseM3U(m3uText);
    }

    function parseM3U(m3uText) {
      const lines = m3uText.split("\n").map(l => l.trim()).filter(l => l.length > 0);
      const entries = [];
      let keyId = "", key = "";

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];

        if (line.startsWith("#KODIPROP:inputstream.adaptive.license_key=")) {
          // Format: license_key=KID:KEY
          const match = line.match(/license_key=([^:]+):(.+)/);
          if (match) {
            keyId = match[1].trim();
            key = match[2].trim();
          }
        } else if (!line.startsWith("#")) {
          // Stream URL line
          entries.push({
            url: line,
            keyId: keyId,
            key: key
          });
          keyId = "";
          key = "";
        }
      }

      return entries;
    }

    async function initPlayer() {
      const entries = await fetchM3U();
      const id = getIdParam();

      if (id < 1 || id > entries.length) {
        document.body.innerHTML = "<h2 style='color:white;text-align:center;'>Invalid ID</h2>";
        return;
      }

      const stream = entries[id - 1];
      console.log("Playing:", stream);

      jwplayer("player").setup({
        file: stream.url,
        type: "dash",
        drm: {
          clearkey: {
            keyId: stream.keyId,
            key: stream.key
          }
        },
        width: "100%",
        height: "100%",
        autostart: true
      });
    }

    initPlayer();
  </script>
</body>
</html>
