<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3er Parser</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin: 0; background: #000; }
    #player { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    let sharedHdnea = "";

    async function fetchM3U() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/alex4528/m3u/main/jstar.m3u');
        const m3uText = await response.text();
        return parseM3U(m3uText);
      } catch (error) {
        console.error('Error fetching M3U:', error);
        return [];
      }
    }

    function parseM3U(m3uText) {
      const lines = m3uText.split('\n').map(line => line.trim());
      const channels = [];
      let currentChannel = null;

      for (const line of lines) {
        if (line.startsWith('#EXTINF:')) {
          currentChannel = {};
          const match = line.match(/tvg-id="([^"]+)"\s+group-title="([^"]+)"\s+tvg-logo="([^"]+)"\s*,(.+)/);
          if (match) {
            currentChannel.id = match[1];
            currentChannel.group = match[2];
            currentChannel.logo = match[3];
            currentChannel.name = match[4];
          }
        } else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
          const keyMatch = line.match(/license_key=([^:]+):(.+)/);
          if (keyMatch && currentChannel) {
            currentChannel.mod = keyMatch[1];
            currentChannel.key = keyMatch[2];
          }
        } else if (line.startsWith('#EXTVLCOPT:http-user-agent=')) {
          if (currentChannel) {
            currentChannel.userAgent = line.replace('#EXTVLCOPT:http-user-agent=', '');
          }
        } else if (line.startsWith('#EXTHTTP:')) {
          const httpMatch = line.match(/"cookie":"__hdnea__=(.+)"/);
          if (httpMatch && currentChannel) {
            currentChannel.hdnea = "__hdnea__=" + httpMatch[1];
            sharedHdnea = httpMatch[1];
          }
        } else if (line && !line.startsWith('#') && currentChannel) {
          currentChannel.url = line.split("&xxx=")[0]; // clean URL
          channels.push(currentChannel);
          currentChannel = null;
        }
      }
      return channels;
    }

    function extractTokenFromLink(link) {
      var tokenMatch = link.match(/__hdnea__=([^&]+)/);
      return tokenMatch ? tokenMatch[1] : '';
    }

    function interceptNetworkRequests(token, userAgent) {
      const originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {
        if ((url.includes('.mpd') || url.includes('.m3u8') || url.includes('.ts')) 
            && token && !url.includes('__hdnea__=')) {
          url += (url.includes('?') ? '&' : '?') + '__hdnea__=' + token;
        }
        originalOpen.apply(this, arguments);
      };

      const originalSend = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function(body) {
        this.setRequestHeader('Referer', 'https://www.jiotv.com/');
        this.setRequestHeader('User-Agent', userAgent || "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6");
        originalSend.apply(this, arguments);
      };
    }

    async function loadAndPlay() {
      const urlParams = new URLSearchParams(window.location.search);
      const channelId = urlParams.get("id");
      if (!channelId) {
        alert("No channel id provided (?id=1373)");
        return;
      }

      const channels = await fetchM3U();
      const channel = channels.find(c => c.id === channelId);

      if (!channel) {
        alert("Channel not found in M3U");
        return;
      }

      const tokenValue = extractTokenFromLink(channel.url);
      if (tokenValue) {
        interceptNetworkRequests(tokenValue, channel.userAgent);
        document.cookie = "__hdnea__=" + tokenValue + "; path=/";
      }

      jwplayer("player").setup({
        playlist: [{
          file: channel.url,
          type: "dash",
          drm: {
            clearkey: {
              [channel.mod]: channel.key
            }
          },
          image: channel.logo,
          title: channel.name
        }],
        width: "100%",
        aspectratio: "16:9",
        autostart: true
      });
    }

    window.onload = loadAndPlay;
  </script>
</body>
</html>
