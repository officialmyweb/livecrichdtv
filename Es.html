<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U â†’ JWPlayer (Clean MPD)</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin: 0; background: #000; }
    #player { width: 100%; height: 100vh; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    const m3uUrl = "https://raw.githubusercontent.com/alex4528/m3u/main/jstar.m3u";

    function getChannelId() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    async function loadM3U() {
      const response = await fetch(m3uUrl);
      const text = await response.text();
      return text.split("\n");
    }

    async function getChannelData(channelId) {
      const lines = await loadM3U();
      let found = false;
      let licenseKey = "";
      let mpdUrl = "";
      let title = "";
      let logo = "";

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        if (line.startsWith("#EXTINF:") && line.includes(`tvg-id="${channelId}"`)) {
          found = true;

          const titleMatch = line.match(/,(.*)$/);
          if (titleMatch) title = titleMatch[1];
          const logoMatch = line.match(/tvg-logo="([^"]+)"/);
          if (logoMatch) logo = logoMatch[1];
        }

        if (found && line.startsWith("#KODIPROP:inputstream.adaptive.license_key=")) {
          licenseKey = line.split("=")[1].trim();
        }

        if (found && line.includes(".mpd")) {
          // Clean MPD: keep only until .mpd?__hdnea__=XXXX
          const match = line.match(/(.+?\.mpd\?__hdnea__=[^&]+)/);
          if (match) {
            mpdUrl = match[1];
          } else {
            mpdUrl = line.trim(); // fallback
          }
          break;
        }
      }

      return { mpdUrl, licenseKey, title, logo };
    }

    function playChannel(mpdUrl, licenseKey, title, logo) {
      if (!mpdUrl || !licenseKey) {
        alert("Channel not found or missing key.");
        return;
      }

      const [kid, key] = licenseKey.split(":");

      jwplayer("player").setup({
        playlist: [{
          file: mpdUrl,
          type: "dash",
          image: logo,
          title: title,
          drm: {
            clearkey: {
              [kid]: key
            }
          }
        }],
        width: "100%",
        aspectratio: "16:9",
        autostart: true
      });
    }

    async function init() {
      const channelId = getChannelId();
      if (!channelId) {
        alert("No channel id provided in ?id=");
        return;
      }

      const channelData = await getChannelData(channelId);
      playChannel(channelData.mpdUrl, channelData.licenseKey, channelData.title, channelData.logo);
    }

    init();
  </script>
</body>
</html>
