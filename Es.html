<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JSON Live Player</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.9.6/dist/shaka-player.compiled.min.js"></script>
  <style>
    body { margin:0; background:#000; }
    video { width:100%; height:100vh; }
  </style>
</head>
<body>

<video id="video" autoplay controls></video>

<script>
  async function initPlayer() {
    const video = document.getElementById('video');
    const player = new shaka.Player(video);

    // Log errors
    player.addEventListener('error', e => console.error("Error:", e));

    try {
      // Fetch your JSON (from worker)
      let res = await fetch("https://pkl.xojiv79335.workers.dev/");
      let data = await res.json();

      // Example: pick first channel (Disney Channel)
      let channel = data[0];  

      console.log("Loaded channel:", channel.channel_name);

      // Configure license + keys
      player.configure({
        drm: {
          clearKeys: {
            [channel.keyId]: channel.key   // KeyId : Key
          }
        },
        streaming: {
          retryParameters: { maxAttempts: 50, baseDelay: 500, backoffFactor: 2 }
        }
      });

      // Set custom headers (cookies / token)
      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        if (type === shaka.net.NetworkingEngine.RequestType.SEGMENT ||
            type === shaka.net.NetworkingEngine.RequestType.MANIFEST) {
          request.headers["cookie"] = channel.cookie;
        }
      });

      // Load the channel
      await player.load(channel.channel_url);
      console.log("Playing:", channel.channel_name);

    } catch (err) {
      console.error("Player init error:", err);
    }
  }

  document.addEventListener('DOMContentLoaded', initPlayer);
</script>

</body>
</html>
