<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U â†’ JWPlayer (Dynamic Parser)</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin:0; background:#000; }
    .jwplayer { position:absolute !important; }
    .jwplayer.jw-flag-aspect-mode { min-height:100%; max-height:100%; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    // --- Token handler logic (KEEPING as you requested) ---
    function setCookie(name, value) {
      document.cookie = name + "=" + value + "; path=/";
    }
    function extractTokenFromLink(link) {
      var tokenMatch = link.match(/__hdnea__=([^&]+)/);
      return tokenMatch ? tokenMatch[1] : '';
    }
    function interceptNetworkRequests(token) {
      const originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {
        if ((url.includes('.dash') || url.includes('.m3u8') || url.includes('.ts')) && token && !url.includes('__hdnea__=')) {
          url += (url.includes('?') ? '&' : '?') + '__hdnea__=' + token;
        }
        originalOpen.apply(this, arguments);
      };
    }

    async function loadAndPlay() {
      const urlParams = new URLSearchParams(window.location.search);
      const channelId = urlParams.get("id");
      if (!channelId) {
        alert("No channel id provided (?id=1984 / ?id=173a / ?id=173s)");
        return;
      }

      const m3uUrl = "https://raw.githubusercontent.com/alex4528/m3u/main/jstar.m3u";
      const response = await fetch(m3uUrl);
      const text = await response.text();
      const lines = text.split("\n");

      let mpdUrl = "", kid = "", key = "";

      // Map short ids to actual M3U entries
      const channelMap = {
        "1984": { id: "1984" },                          // Sports18_1_HD
        "173a": { id: "173", name: "Star Sports 1 Hindi HD" },
        "173s": { id: "173", name: "Aaj Tak" }
      };

      const target = channelMap[channelId];
      if (!target) {
        alert("Invalid channel id.");
        return;
      }

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].includes(`tvg-id="${target.id}"`)) {
          // If there are two 173 entries, filter by channel name
          if (target.name && !lines[i].includes(target.name)) continue;

          for (let j = i + 1; j < lines.length; j++) {
            if (lines[j].startsWith("#EXTINF")) break; 

            if (lines[j].includes("license_key=")) {
              const match = lines[j].match(/license_key=([^:]+):([a-f0-9]+)/i);
              if (match) {
                kid = match[1];
                key = match[2];
              }
            }

            if (lines[j].includes(".mpd")) {
              const urlMatch = lines[j].match(/(https?:\/\/[^\s]+?\.mpd\?[^\s]+)/);
              if (urlMatch) {
                mpdUrl = urlMatch[1].split("&xxx=")[0]; // clean unwanted garbage
              }
            }
          }
          break;
        }
      }

      if (!mpdUrl || !kid || !key) {
        alert("Parsing failed for channel " + channelId);
        return;
      }

      // Apply token handler
      const tokenValue = extractTokenFromLink(mpdUrl);
      if (tokenValue) {
        setCookie("__hdnea__", tokenValue);
        interceptNetworkRequests(tokenValue);
      }

      // JWPlayer setup
      jwplayer("player").setup({
        playlist: [{
          file: mpdUrl,
          type: "dash",
          drm: {
            clearkey: {
              [kid]: key
            }
          }
        }],
        width: "100%",
        aspectratio: "16:9",
        autostart: true
      });
    }

    window.onload = loadAndPlay;
  </script>
</body>
</html>
