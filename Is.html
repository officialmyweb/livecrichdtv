<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JWPlayer Worker Single Channel</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin:0; background:#000; }
    .jwplayer { position:absolute !important; }
    .jwplayer.jw-flag-aspect-mode { min-height:100%; max-height:100%; }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    // --- Token / cookie handler ---
    function setCookie(name, value) {
      document.cookie = name + "=" + value + "; path=/";
    }

    function extractTokenFromLink(link) {
      const tokenMatch = link.match(/__hdnea__=([^&]+)/);
      return tokenMatch ? tokenMatch[1] : '';
    }

    function interceptNetworkRequests(token) {
      const originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(method, url) {

        // --- Your custom Jio domain logic ---
        if (url.startsWith('https://tv.media.jio.com/')) {
          url = url.replace('tv.media.jio.com', 'tv.media.jio.com');
        }

        // --- Add __hdnea__ token if needed ---
        if ((url.includes('.dash') || url.includes('.m3u8') || url.includes('.ts')) && token && !url.includes('__hdnea__=')) {
          url += (url.includes('?') ? '&' : '?') + '__hdnea__=' + token;
        }

        return originalOpen.apply(this, arguments);
      };
    }

    async function loadAndPlay() {
      const urlParams = new URLSearchParams(window.location.search);
      const channelId = urlParams.get("id");

      if (!channelId) {
        alert("No channel ID provided. Use ?id=YOUR_ID");
        return;
      }

      // Fetch single-channel JSON from worker
      const workerUrl = `https://pkll.xojiv79335.workers.dev/?id=${channelId}`;
      const response = await fetch(workerUrl);
      const channelData = await response.json();

      if (!channelData || Object.keys(channelData).length === 0) {
        alert("Channel not found or invalid ID: " + channelId);
        return;
      }

      // Apply token handling + network interception
      const tokenValue = extractTokenFromLink(channelData.channel_url);
      if (tokenValue) {
        setCookie("__hdnea__", tokenValue);
        interceptNetworkRequests(tokenValue);
      } else {
        interceptNetworkRequests(null); // still intercept Jio URLs
      }

      // JWPlayer setup
      jwplayer("player").setup({
        playlist: [{
          file: channelData.channel_url,  // clean URL from worker
          type: "dash",
          drm: {
            clearkey: {
              [channelData.keyId]: channelData.key
            }
          }
        }],
        width: "100%",
        aspectratio: "16:9",
        autostart: true
      });
    }

    window.onload = loadAndPlay;
  </script>
</body>
</html>
