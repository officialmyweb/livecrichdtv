<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>M3U â†’ JWPlayer (Dynamic Parser)</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin: 0; }
    .jwplayer { position: absolute !important; }
    .jwplayer.jw-flag-aspect-mode {
      min-height: 100%;
      max-height: 100%;
    }
  </style>
</head>
<body>
  <div id="player"></div>

  <script>
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    function setCookie(name, value) {
      document.cookie = name + "=" + value + "; path=/";
    }

    function extractTokenFromLink(link) {
      const tokenMatch = link.match(/__hdnea__=([^&]+)/);
      return tokenMatch ? tokenMatch[1] : '';
    }

    function interceptNetworkRequests(token) {
      const originalOpen = XMLHttpRequest.prototype.open;
      const originalSend = XMLHttpRequest.prototype.send;

      XMLHttpRequest.prototype.open = function(method, url) {
        // ðŸ”€ Replace domain with proxy if needed
        if (url.startsWith("https://tv.media.jio.com/")) {
          url = url.replace("tv.media.jio.com", "thai.myproxy.com");
        }

        // ðŸ”‘ Add token if missing
        if ((url.includes(".mpd") || url.includes(".m3u8") || url.includes(".ts")) &&
            token && !url.includes("__hdnea__=")) {
          url += (url.includes("?") ? "&" : "?") + "__hdnea__=" + token;
        }

        this._url = url;
        originalOpen.call(this, method, url);
      };

      XMLHttpRequest.prototype.send = function(body) {
        try {
          this.setRequestHeader("Referer", "https://jiotv.com/");
          this.setRequestHeader("Origin", "https://jiotv.com");
          this.setRequestHeader("User-Agent", "plaYtv/7.1.3 (Linux;Android 13) ExoPlayerLib/824.0");
        } catch (e) {}
        originalSend.call(this, body);
      };

      // --- Intercept fetch as well (for JWPlayer >= 8.30) ---
      const originalFetch = window.fetch;
      window.fetch = function(input, init = {}) {
        let url = (typeof input === "string") ? input : input.url;

        // Proxy replacement
        if (url.startsWith("https://tv.media.jio.com/")) {
          url = url.replace("tv.media.jio.com", "thai.myproxy.com");
        }

        // Token append
        if ((url.includes(".mpd") || url.includes(".m3u8") || url.includes(".ts")) &&
            token && !url.includes("__hdnea__=")) {
          url += (url.includes("?") ? "&" : "?") + "__hdnea__=" + token;
        }

        // Force headers
        init.headers = Object.assign({}, init.headers, {
          "Referer": "https://jiotv.com/",
          "Origin": "https://jiotv.com",
          "User-Agent": "plaYtv/7.1.3 (Linux;Android 13) ExoPlayerLib/824.0"
        });

        return originalFetch(url, init);
      };
    }

    async function loadAndPlay() {
      const urlParams = new URLSearchParams(window.location.search);
      const channelId = urlParams.get("id");
      if (!channelId) {
        alert("No channel id provided (?id=1373)");
        return;
      }

      const m3uUrl = "https://raw.githubusercontent.com/alex4528/m3u/main/jstar.m3u";
      const response = await fetch(m3uUrl);
      const text = await response.text();

      const blocks = text.split("#EXTINF").slice(1);
      let mpdUrl = "", kid = "", key = "", title = "", logo = "";

      for (let block of blocks) {
        const idMatch = block.match(/tvg-id="(\d+)"/);
        if (idMatch && idMatch[1] === channelId) {
          const nameMatch = block.match(/,(.+)$/m);
          if (nameMatch) title = nameMatch[1].trim();

          const logoMatch = block.match(/tvg-logo="([^"]+)"/);
          if (logoMatch) logo = logoMatch[1];

          const keyMatch = block.match(/license_key=([a-f0-9]+):([a-f0-9]+)/i);
          if (keyMatch) {
            kid = keyMatch[1];
            key = keyMatch[2];
          }

          const mpdMatch = block.match(/(https?:\/\/[^\s]+?\.mpd[^\s]*)/);
          if (mpdMatch) {
            mpdUrl = mpdMatch[1].split("&xxx=")[0];
          }
          break;
        }
      }

      if (!mpdUrl || !kid || !key) {
        alert("Channel not found or parsing failed.");
        return;
      }

      const tokenValue = extractTokenFromLink(mpdUrl);
      if (tokenValue) {
        setCookie("__hdnea__", tokenValue);
        interceptNetworkRequests(tokenValue);
      }

      jwplayer("player").setup({
        playlist: [{
          file: mpdUrl,
          type: "dash",
          drm: { clearkey: { [kid]: key } },
          image: logo || "",
          title: title || "Live Channel"
        }],
        width: "100%",
        aspectratio: "16:9",
        autostart: true
      });
    }

    window.onload = loadAndPlay;
  </script>
</body>
</html>
