<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Shaka Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background: #000;
      overflow: hidden;
    }
    .shaka-video-container {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    video {
      width: 100%;
      height: 100%;
      background: #000;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div class="shaka-video-container">
    <video autoplay playsinline></video>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      shaka.polyfill.installAll();
      if (!shaka.Player.isBrowserSupported()) {
        console.error("Browser not supported");
        return;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const channelId = urlParams.get("id") || "1001"; // default Hindi
      console.log("Requested channel ID:", channelId);

      const video = document.querySelector("video");
      const player = new shaka.Player(video);

      const container = document.querySelector(".shaka-video-container");
      const ui = new shaka.ui.Overlay(player, container, video);
      ui.configure({
        controlPanelElements: [
          "play_pause", "time_and_duration", "mute", "volume",
          "spacer", "quality", "fullscreen"
        ]
      });

      async function getChannelConfig(id) {
        const res = await fetch("https://pkll.xojiv79335.workers.dev/", {cache:"no-store"});
        const data = await res.json();
        return data.find(ch => ch.channel_id === id);
      }

      const channel = await getChannelConfig(channelId);
      if (!channel) {
        console.error("Channel not found for id", channelId);
        return;
      }

      console.log("Loaded channel:", channel.channel_name);

      player.configure({
        drm: {
          clearKeys: { [channel.keyId]: channel.key }
        },
        streaming: {
          lowLatencyMode: true,
          bufferingGoal: 15,
          rebufferingGoal: 2
        }
      });

      player.getNetworkingEngine().registerRequestFilter((type, request) => {
        request.headers["Referer"] = "https://www.jiotv.com/";
        request.headers["User-Agent"] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
        if (channel.cookie) {
          if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
              type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
            const separator = request.uris[0].includes("?") ? "&" : "?";
            request.uris[0] += separator + channel.cookie;
          }
        }
      });

      try {
        await player.attach(video);
        await player.load(channel.channel_url);
      } catch (err) {
        console.error("Playback error:", err);
      }
    });
  </script>
</body>
</html>
