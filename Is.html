<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sliv Hindi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">
</head>
<body>

<div class="shaka-video-container">
  <video autoplay playsinline></video>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  shaka.polyfill.installAll();

  if (!shaka.Player.isBrowserSupported()) {
    console.error('Browser not supported');
    return;
  }

  const video = document.querySelector('video');
  const container = document.querySelector('.shaka-video-container');
  const player = new shaka.Player();
  await player.attach(video);

  const ui = new shaka.ui.Overlay(player, container, video);
  ui.configure({
    controlPanelElements: [
      'play_pause','time_and_duration','mute','volume',
      'spacer','language','captions','picture_in_picture',
      'quality','fullscreen'
    ],
    volumeBarColors: { base: 'rgba(63,187,1,1)', level: 'rgb(255,69,0)' },
    seekBarColors: { base:'rgb(41,41,163)', buffered:'rgb(35,99,3)', played:'rgba(63,187,1,1)' }
  });

  // ClearKey DRM
  let drmConfig = {
    clearKeys: { "31b13c6f241055aaa965263f3115e684":"61f0cbc9599925a7be93d45e30b8ebe9" }
  };

  // Token fetch
  let cookieHeader = "";
  async function fetchTokenFromSite() {
    try {
      const res = await fetch('https://livecrichdtv.pages.dev/Hindi.txt',{cache:'no-store',mode:'cors'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const txt = (await res.text()).trim();
      if(txt){ cookieHeader = txt; console.log('Token fetched:', cookieHeader); return true; }
    } catch(e){ console.warn('Failed to fetch token:', e.message); }
    return false;
  }
  await fetchTokenFromSite();
  setInterval(fetchTokenFromSite,5*60*1000);

  player.configure({
    drm: drmConfig,
    streaming: {
      lowLatencyMode:true,
      bufferingGoal:15,
      rebufferingGoal:2,
      bufferBehind:15,
      retryParameters:{ timeout:10000,maxAttempts:5,baseDelay:300,backoffFactor:1.2 },
      segmentRequestTimeout:8000,
      segmentPrefetchLimit:2,
      useNativeHlsOnSafari:true
    },
    manifest:{ retryParameters:{ timeout:8000,maxAttempts:3 } }
  });

  // Append cookies to manifest/segment requests
  player.getNetworkingEngine().registerRequestFilter((type, request) => {
    request.headers['Referer']='https://www.jiotv.com/';
    request.headers['User-Agent']="plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
    if(cookieHeader) request.headers['Cookie'] = cookieHeader;
    if((type===shaka.net.NetworkingEngine.RequestType.MANIFEST ||
        type===shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
        request.uris[0] && !request.uris[0].includes('__hdnea__=')) {
      const sep = request.uris[0].includes('?') ? '&' : '?';
      request.uris[0]+=sep+cookieHeader;
    }
  });

  const enableAutoplay = ()=>{ video.setAttribute('autoplay',''); video.setAttribute('playsinline',''); video.autoplay=true; };

  const attemptAutoplay = async ()=>{
    try{ video.muted=false; await video.play(); console.log('Unmuted autoplay success'); return true; }
    catch(err){ console.log('Unmuted autoplay failed:',err.message); try{ video.muted=true; await video.play(); console.log('Muted autoplay success'); return true; } catch(e){ console.log('Muted autoplay failed'); return false; } }
  };

  player.addEventListener('error',e=>console.error('Shaka Player Error:',e.detail));

  video.addEventListener('play',()=>{
    if(window.self===window.top && !document.fullscreenElement && window.innerWidth<=768){
      container.requestFullscreen().catch(()=>console.log('Fullscreen request failed'));
    }
  },{once:true});

  video.addEventListener('loadedmetadata',()=>{ video.volume=0.8; });

  let hasUserInteracted=false;
  const enableSoundOnInteraction=()=>{
    if(!hasUserInteracted && video.muted){ video.muted=false; hasUserInteracted=true; console.log('Sound enabled after interaction'); }
  };
  ['click','touchstart','keydown'].forEach(e=>document.addEventListener(e,enableSoundOnInteraction,{once:true}));

  try{
    enableAutoplay();
    await player.load("https://jiotvbpkmob.cdn.jio.com/bpk-tv/Asia_Cup_Hindi_MOB/WDVLive/index.mpd");
    if(video.readyState>=3){ await attemptAutoplay(); } 
    else{ video.addEventListener('canplay', attemptAutoplay, {once:true}); setTimeout(async()=>{ if(video.paused) await attemptAutoplay(); },2000); }
  } catch(error){ console.error('Load error:',error); }

  document.addEventListener('visibilitychange',()=>{ if(!document.hidden && video.paused) attemptAutoplay(); });
});
</script>

</body>
</html>
