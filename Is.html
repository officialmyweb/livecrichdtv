<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>JWPlayer JSON All Channels</title>
  <script src="https://content.jwplatform.com/libraries/SAHhwvZq.js"></script>
  <style>
    body { margin:0; background:#000; font-family:sans-serif; color:#fff; }
    .jwplayer { position:absolute !important; }
    .jwplayer.jw-flag-aspect-mode { min-height:100%; max-height:100%; }
    #channelList { position: fixed; top: 10px; left: 10px; z-index:1000; background: rgba(0,0,0,0.6); padding:10px; border-radius:5px; }
    #channelList select { padding:5px; font-size:16px; }
  </style>
</head>
<body>

<div id="channelList">
  <label for="channels">Select Channel:</label>
  <select id="channels"></select>
</div>

<div id="player"></div>

<script>
  jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

  // --- Token / cookie handler ---
  function setCookie(name, value) {
    document.cookie = name + "=" + value + "; path=/";
  }
  function extractTokenFromLink(link) {
    const tokenMatch = link.match(/__hdnea__=([^&]+)/);
    return tokenMatch ? tokenMatch[1] : '';
  }
  function interceptNetworkRequests(token) {
    const originalOpen = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(method, url) {
      if ((url.includes('.dash') || url.includes('.m3u8') || url.includes('.ts')) && token && !url.includes('__hdnea__=')) {
        url += (url.includes('?') ? '&' : '?') + '__hdnea__=' + token;
      }
      originalOpen.apply(this, arguments);
    };
  }

  async function loadChannels() {
    const jsonUrl = "https://pkll.xojiv79335.workers.dev/";
    const response = await fetch(jsonUrl);
    const channels = await response.json();

    const select = document.getElementById("channels");

    // Fill dropdown
    channels.forEach(c => {
      const option = document.createElement("option");
      option.value = c.channel_id;
      option.textContent = c.channel_name;
      select.appendChild(option);
    });

    // Get ?id param or default to first channel
    const urlParams = new URLSearchParams(window.location.search);
    const initialId = urlParams.get("id") || channels[0].channel_id;

    select.value = initialId;

    // Play initial channel
    playChannel(initialId, channels);

    // Listen for change
    select.addEventListener("change", e => {
      playChannel(e.target.value, channels);
    });
  }

  function playChannel(channelId, channels) {
    const channelData = channels.find(c => c.channel_id === channelId);
    if (!channelData) {
      alert("Channel not found: " + channelId);
      return;
    }

    // Apply token handler
    const tokenValue = extractTokenFromLink(channelData.channel_url);
    if (tokenValue) {
      setCookie("__hdnea__", tokenValue);
      interceptNetworkRequests(tokenValue);
    }

    jwplayer("player").setup({
      playlist: [{
        file: channelData.channel_url,
        type: "dash",
        drm: {
          clearkey: {
            [channelData.keyId]: channelData.key
          }
        }
      }],
      width: "100%",
      aspectratio: "16:9",
      autostart: true
    });
  }

  window.onload = loadChannels;
</script>

</body>
</html>
