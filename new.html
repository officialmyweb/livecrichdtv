<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="no-referrer" />
  <title>Telegram-Live-Cric-Hd</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.12.6/controls.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://livecrichdofficial.pages.dev/livecrichd2.css" />
</head>
<body>
<div id="player-container">
  <div data-shaka-player-container class="shaka-video-container">
    <video autoplay data-shaka-player id="video" poster="https://i.ibb.co/wzxpfcC/IMG-20240601-170942.jpg"></video>
  </div>
</div>

<script defer src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>

<script>
  const allowedDomain = "livecrichdtv.pages.dev";
  if (window.top !== window.self || window.location.hostname !== allowedDomain) {
    window.top.location.href = "https://telegram.me/livecrichdofficial";
  }

  if (confirm("Join Our Telegram Channel @livecrichdofficial")) {
    window.location.href = "https://telegram.me/livecrichdofficial";
  }

  const manifestUri = "https://otte.live.fly.ww.aiv-cdn.net/pdx-nitro/live/clients/dash/enc/tftudkctiy/out/v1/21d351e17f284d56ba835597fcac3e3c/cenc.mpd";
  const drmKeys = {
    "c5baabaaf817abc314702e6fc615571f": "35f6b737c5b2c3d657a37b2bff894916"
  };

  let player;
  let video;

  async function initPlayer() {
    video = document.getElementById("video");
    const ui = video["ui"];
    const controls = ui.getControls();
    player = controls.getPlayer();

    ui.configure({
      controlPanelElements: ["play_pause", "mute", "spacer", "time_and_duration", "quality", "fullscreen", "picture_in_picture", "overflow_menu"],
      overflowMenuButtons: ["captions", "cast", "quality", "language"]
    });

    player.configure({
      drm: { clearKeys: drmKeys },
      streaming: {
        lowLatencyMode: true,
        rebufferingGoal: 10,
        bufferingGoal: 15,
        liveSyncDuration: 10,
        jumpLargeGaps: true,
        inaccurateManifestTolerance: 5,
        startAtSegmentBoundary: true
      },
      abr: { enabled: false } // force HD
    });

    player.addEventListener("error", e => console.error("Player error", e.detail));
    controls.addEventListener("error", e => console.error("UI error", e.detail));

    await loadStream();
    setupStuckDetector();
  }

  async function loadStream() {
    try {
      await player.load(manifestUri);
      const liveEdge = player.seekRange().end;
      video.currentTime = liveEdge;

      // Lock HD track
      const tracks = player.getVariantTracks();
      const hdTrack = tracks.find(t => t.height === 1080) || tracks.find(t => t.height === 720);
      if (hdTrack) {
        player.selectVariantTrack(hdTrack, true);
        console.log("HD Locked at", hdTrack.height);
      }

    } catch (err) {
      console.error("Error loading video:", err);
    }
  }

  function setupStuckDetector() {
    let lastTime = 0;
    let stuckCount = 0;

    setInterval(async () => {
      if (video.paused || video.readyState < 2) return;

      if (Math.abs(video.currentTime - lastTime) < 0.01) {
        stuckCount++;
      } else {
        stuckCount = 0;
      }

      lastTime = video.currentTime;

      if (stuckCount >= 4) { // ~8-10 seconds stuck
        console.warn("Detected stuck playback. Soft reloading player...");

        const currentTrack = player.getVariantTracks().find(t => t.active);
        const currentQuality = currentTrack ? currentTrack.height : null;

        await player.unload();
        await player.load(manifestUri);

        // Jump to live again
        video.currentTime = player.seekRange().end;

        // Re-lock quality if needed
        if (currentQuality) {
          const newTrack = player.getVariantTracks().find(t => t.height === currentQuality);
          if (newTrack) {
            player.selectVariantTrack(newTrack, true);
            console.log("Restored quality:", newTrack.height);
          }
        }

        stuckCount = 0;
      }
    }, 2000);
  }

  function configureLogo() {
    const logo = document.createElement("img");
    logo.src = "https://i.ibb.co/7VF2dfy/1000000077-removebg-preview.png";
    logo.alt = "Logo";
    logo.className = "logo";
    logo.addEventListener("click", () => {
      window.location.href = "https://telegram.me/livecrichdofficial";
    });
    document.querySelector(".shaka-video-container").appendChild(logo);
  }

  document.addEventListener("shaka-ui-loaded", () => {
    initPlayer();
    configureLogo();
  });

  document.addEventListener("shaka-ui-load-failed", () => {
    console.error("Unable to load the Shaka UI!");
  });
</script>
</body>
</html>
